# TokenAirDrop ç­¾åéªŒç­¾æŠ€æœ¯æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº† TokenAirDrop ç³»ç»Ÿä¸­åç«¯ç­¾åæœåŠ¡ä¸æ™ºèƒ½åˆçº¦éªŒè¯ä¹‹é—´çš„æŠ€æœ¯äº¤äº’æµç¨‹ï¼ŒåŒ…å«æ ¸å¿ƒä»£ç åˆ†æã€å¯†ç å­¦åŸç†è¯´æ˜å’Œå®Œæ•´çš„ç­¾åéªŒç­¾æ¶æ„ã€‚

## ğŸ”„ ç­¾åéªŒç­¾æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·é’±åŒ…
    participant Frontend as å‰ç«¯åº”ç”¨
    participant Backend as åç«¯ç­¾åæœåŠ¡
    participant Contract as TokenAirDropåˆçº¦
    participant Token as Tokenåˆçº¦

    Note over User,Token: TokenAirDrop ç­¾åéªŒç­¾å®Œæ•´æµç¨‹

    %% 1. ç”¨æˆ·å‘èµ·é¢†å–è¯·æ±‚
    User->>Frontend: ç‚¹å‡»é¢†å–ä»£å¸
    Frontend->>Backend: POST /api/signatures/generate
    Note right of Frontend: è¯·æ±‚å‚æ•°ï¼š<br/>userAddress, tokenAddress, amount

    %% 2. åç«¯ç”Ÿæˆç­¾å
    Backend->>Backend: ä½¿ç”¨ ethers.js ç§é’¥ç­¾å
    Note right of Backend: æ ¸å¿ƒæŠ€æœ¯æ ˆï¼š<br/>- ethers.solidityPackedKeccak256<br/>- wallet.signMessage
    Backend->>Frontend: è¿”å›ç­¾åæ•°æ®
    Note right of Backend: è¿”å›ï¼šsignature, nonce, expireAt

    %% 3. å‰ç«¯æäº¤äº¤æ˜“
    Frontend->>User: è¯·æ±‚é’±åŒ…ç­¾åäº¤æ˜“
    User->>Frontend: ç¡®è®¤äº¤æ˜“
    Frontend->>Contract: è°ƒç”¨ claimToken()
    Note right of Frontend: å‚æ•°ï¼štokenAddress, amount,<br/>nonce, expireAt, signature

    %% 4. åˆçº¦éªŒè¯ç­¾å
    Contract->>Contract: é‡æ„æ¶ˆæ¯å“ˆå¸Œ
    Note right of Contract: keccak256(abi.encodePacked(...))
    Contract->>Contract: ECDSA ç­¾åæ¢å¤
    Note right of Contract: ECDSA.recover(hash, signature)
    Contract->>Contract: éªŒè¯ç­¾åè€…èº«ä»½
    Note right of Contract: require(signer == trustedSigner)

    %% 5. æ‰§è¡Œä»£å¸é“¸é€ 
    Contract->>Token: è°ƒç”¨ mint() å‡½æ•°
    Note right of Contract: éœ€è¦ minter æƒé™
    Token->>Contract: é“¸é€ æˆåŠŸ
    Contract->>Frontend: äº¤æ˜“å®Œæˆ
    Frontend->>User: æ˜¾ç¤ºæˆåŠŸçŠ¶æ€

    %% é”™è¯¯å¤„ç†
    Note over Contract: éªŒè¯å¤±è´¥æƒ…å†µï¼š<br/>- ç­¾åæ— æ•ˆ<br/>- nonceå·²ä½¿ç”¨<br/>- ç­¾åè¿‡æœŸ<br/>- æ— minteræƒé™
```

## ğŸ’» æ ¸å¿ƒä»£ç åˆ†æ

### åç«¯ç­¾åæœåŠ¡ (signer.js)

```javascript
// æ ¸å¿ƒç­¾åå‡½æ•°å®ç°
const generateSignature = async (userAddress, tokenAddress, amount, expireAt) => {
  // 1. ç”Ÿæˆå”¯ä¸€ nonce
  const nonce = Math.floor(Math.random() * 1000000000);
  
  // 2. æ„é€ æ¶ˆæ¯å“ˆå¸Œ (ä¸åˆçº¦ä¿æŒä¸€è‡´)
  const messageHash = ethers.solidityPackedKeccak256(
    ["address", "address", "uint256", "uint256", "uint256"],
    [userAddress, tokenAddress, amount, nonce, expireAt]
  );
  
  // 3. ä½¿ç”¨ç§é’¥ç­¾å
  const signature = await wallet.signMessage(ethers.getBytes(messageHash));
  
  return { signature, nonce, expireAt };
};
```

**æŠ€æœ¯è¦ç‚¹ï¼š**
- **ethers.js**: ä½¿ç”¨ `solidityPackedKeccak256` ç¡®ä¿ä¸ Solidity `abi.encodePacked` ä¸€è‡´
- **ç§é’¥ç®¡ç†**: ç¯å¢ƒå˜é‡å­˜å‚¨ï¼Œç”Ÿäº§ç¯å¢ƒéœ€è¦ HSM æˆ–å¯†é’¥ç®¡ç†æœåŠ¡
- **æ¶ˆæ¯å“ˆå¸Œ**: åŒ…å«æ‰€æœ‰å…³é”®å‚æ•°é˜²æ­¢é‡æ”¾æ”»å‡»

### æ™ºèƒ½åˆçº¦éªŒè¯ (TokenAirDrop.sol)

```solidity
// æ ¸å¿ƒéªŒè¯å‡½æ•°å®ç°
function claimToken(
    address tokenAddress,
    uint256 amount,
    uint256 nonce,
    uint256 expireAt,
    bytes memory signature
) external {
    // 1. åŸºç¡€éªŒè¯
    require(block.timestamp <= expireAt, "Signature expired");
    require(!nonceUsed[nonce], "Nonce already used");
    
    // 2. é‡æ„æ¶ˆæ¯å“ˆå¸Œ
    bytes32 messageHash = keccak256(abi.encodePacked(
        msg.sender,      // userAddress
        tokenAddress,
        amount,
        nonce,
        expireAt
    ));
    
    // 3. è½¬æ¢ä¸ºä»¥å¤ªåŠç­¾åæ ¼å¼
    bytes32 ethSignedMessageHash = MessageHashUtils.toEthSignedMessageHash(messageHash);
    
    // 4. æ¢å¤ç­¾åè€…åœ°å€
    address recoveredSigner = ECDSA.recover(ethSignedMessageHash, signature);
    
    // 5. éªŒè¯ç­¾åè€…èº«ä»½
    require(recoveredSigner == signer, "Invalid signature");
    
    // 6. æ ‡è®°nonceå·²ä½¿ç”¨
    nonceUsed[nonce] = true;
    
    // 7. é“¸é€ ä»£å¸
    MockToken(tokenAddress).mint(msg.sender, amount);
}
```

**æŠ€æœ¯è¦ç‚¹ï¼š**
- **OpenZeppelin ECDSA**: å®‰å…¨çš„ç­¾åæ¢å¤å®ç°
- **MessageHashUtils**: æ ‡å‡†ä»¥å¤ªåŠç­¾åæ ¼å¼è½¬æ¢
- **é˜²é‡æ”¾æ”»å‡»**: nonce æœºåˆ¶ç¡®ä¿ç­¾ååªèƒ½ä½¿ç”¨ä¸€æ¬¡
- **æƒé™æ§åˆ¶**: éœ€è¦åœ¨ Token åˆçº¦ä¸­æˆäºˆ minter æƒé™

## ğŸ” å¯†ç å­¦åŸç†è¯¦è§£

### ECDSA æ•°å­—ç­¾åç®—æ³•

1. **ç­¾åç”Ÿæˆ** (åç«¯)ï¼š
   ```
   ç§é’¥ + æ¶ˆæ¯å“ˆå¸Œ â†’ æ•°å­—ç­¾å
   signature = sign(privateKey, messageHash)
   ```

2. **ç­¾åéªŒè¯** (åˆçº¦)ï¼š
   ```
   æ•°å­—ç­¾å + æ¶ˆæ¯å“ˆå¸Œ â†’ å…¬é’¥åœ°å€
   publicAddress = recover(signature, messageHash)
   ```

### æ¶ˆæ¯å“ˆå¸Œæ„é€ 

```solidity
// Solidity åˆçº¦ç«¯
bytes32 messageHash = keccak256(abi.encodePacked(
    msg.sender,      // 0xa98C3E7B36d38Ce4f0c15d064a42a4846c979479
    tokenAddress,    // 0x550a3fc779b68919b378c1925538af7065a2a761
    amount,          // 1000000000000000000
    nonce,           // 280646034
    expireAt         // 1727089234
));
```

```javascript
// JavaScript åç«¯
const messageHash = ethers.solidityPackedKeccak256(
    ["address", "address", "uint256", "uint256", "uint256"],
    [userAddress, tokenAddress, amount, nonce, expireAt]
);
```

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„äº¤äº’

### ç³»ç»Ÿç»„ä»¶

1. **åç«¯ç­¾åæœåŠ¡**
   - æŠ€æœ¯æ ˆï¼šNode.js + ethers.js
   - èŒè´£ï¼šç”Ÿæˆå¯†ç å­¦ç­¾å
   - ç§é’¥ï¼š`0x7ad968ae67253103d1357aefec508469e7e88a4566233b30f100exxxxxxxxx`
   - å¯¹åº”åœ°å€ï¼š`0xa98C3E7B36d38Ce4f0c15d064a42a4xxxxx`

2. **æ™ºèƒ½åˆçº¦éªŒè¯**
   - æŠ€æœ¯æ ˆï¼šSolidity + OpenZeppelin
   - èŒè´£ï¼šéªŒè¯ç­¾åæœ‰æ•ˆæ€§
   - åˆçº¦åœ°å€ï¼š`0x53850d0eb69feB0F2616e2A89AC9eFBE4A441569`
   - å¯ä¿¡ç­¾åè€…ï¼š`0xa98C3E7B36d38Ce4f0c15d064a42a4846c979479`

3. **å‰ç«¯åº”ç”¨**
   - æŠ€æœ¯æ ˆï¼šReact + wagmi + viem
   - èŒè´£ï¼šç”¨æˆ·äº¤äº’å’Œäº¤æ˜“æäº¤
   - ç‰¹ç‚¹ï¼šä¸å‚ä¸ç­¾åï¼Œåªè´Ÿè´£ä¼ é€’

### å®‰å…¨æœºåˆ¶

1. **æ—¶é—´é™åˆ¶**: `expireAt` é˜²æ­¢ç­¾åé•¿æœŸæœ‰æ•ˆ
2. **é˜²é‡æ”¾**: `nonce` æœºåˆ¶ç¡®ä¿ç­¾åå”¯ä¸€æ€§
3. **æƒé™æ§åˆ¶**: åªæœ‰å¯ä¿¡ç­¾åè€…çš„ç­¾åæœ‰æ•ˆ
4. **åˆçº¦æƒé™**: TokenAirDrop éœ€è¦ Token åˆçº¦çš„ minter æƒé™

## ğŸš¨ å…³é”®å®‰å…¨æ³¨æ„äº‹é¡¹

### å½“å‰å·²çŸ¥é—®é¢˜

1. **Minter æƒé™ç¼ºå¤±**
   ```bash
   # WBTC æœ‰æƒé™ (å¯ä»¥é¢†å–)
   cast call 0x550a3fc779b68919b378c1925538af7065a2a761 \
     "hasRole(bytes32,address)" \
     0x9f2df0fed2c77648de5860a4cc508cd0818c85b8b8a1ab4ceeef8d981c8956a6 \
     0x53850d0eb69feB0F2616e2A89AC9eFBE4A441569
   # è¿”å›: 0x0000000000000000000000000000000000000000000000000000000000000001

   # å…¶ä»–ä»£å¸æ— æƒé™ (æ— æ³•é¢†å–)
   # USDC: 0x279b091df8fd4a07a01231dcfea971d2abcae0f8
   # USDT: 0xda988ddbbb4797affe6efb1b267b7d4b29b604eb
   # LINK: 0x1847d3dba09a81e74b31c1d4c9d3220452ab3973
   # UNI:  0x237b68901458be70498b923a943de7f885c89943
   ```

2. **æƒé™é…ç½®è„šæœ¬**
   ```bash
   # éœ€è¦æ‰§è¡Œ setup_minter_permissions.sh ä¸ºæ‰€æœ‰ä»£å¸æˆæƒ
   ./setup_minter_permissions.sh
   ```

### ç”Ÿäº§ç¯å¢ƒå»ºè®®

1. **ç§é’¥ç®¡ç†**: ä½¿ç”¨ AWS KMS æˆ– Azure Key Vault
2. **é€Ÿç‡é™åˆ¶**: API æ·»åŠ è¯·æ±‚é¢‘ç‡é™åˆ¶
3. **ç›‘æ§å‘Šè­¦**: å¼‚å¸¸ç­¾åè¯·æ±‚ç›‘æ§
4. **æƒé™å®¡è®¡**: å®šæœŸæ£€æŸ¥åˆçº¦æƒé™é…ç½®

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

- **ç­¾åç”Ÿæˆ**: ~10ms (æœ¬åœ°ç¯å¢ƒ)
- **åˆçº¦éªŒè¯**: ~50,000 gas
- **äº¤æ˜“ç¡®è®¤**: ~15ç§’ (Sepolia ç½‘ç»œ)

## ğŸ› ï¸ è°ƒè¯•å·¥å…·

### æ£€æŸ¥åˆçº¦çŠ¶æ€
```bash
# æŸ¥çœ‹å¯ä¿¡ç­¾åè€…
cast call 0x53850d0eb69feB0F2616e2A89AC9eFBE4A441569 "signer()" \
  --rpc-url https://ethereum-sepolia-rpc.publicnode.com

# æ£€æŸ¥ nonce æ˜¯å¦å·²ä½¿ç”¨
cast call 0x53850d0eb69feB0F2616e2A89AC9eFBE4A441569 \
  "nonceUsed(uint256)" 280646034 \
  --rpc-url https://ethereum-sepolia-rpc.publicnode.com
```

### æµ‹è¯•ç­¾åç”Ÿæˆ
```bash
curl -X POST "https://signer-node-di7tf9o2i-xiaolis-projects-1babd2b2.vercel.app/api/signatures/generate" \
-H "Content-Type: application/json" \
-d '{
  "userAddress": "0xa98C3E7B36d38Ce4f0c15d064a42a4846c979479",
  "tokenAddress": "0x550a3fc779b68919b378c1925538af7065a2a761", 
  "amount": "1000000000000000000"
}'
```

## ğŸ“ æ€»ç»“

TokenAirDrop ç³»ç»Ÿé‡‡ç”¨äº†ç»å…¸çš„**é“¾ä¸‹ç­¾å + é“¾ä¸ŠéªŒè¯**æ¶æ„ï¼š

1. **åç«¯**: ä½¿ç”¨ ethers.js å’Œç§é’¥ç”Ÿæˆ ECDSA ç­¾å
2. **åˆçº¦**: ä½¿ç”¨ OpenZeppelin åº“éªŒè¯ç­¾åå¹¶æ¢å¤ç­¾åè€…åœ°å€
3. **å®‰å…¨**: é€šè¿‡ nonceã€è¿‡æœŸæ—¶é—´å’Œå¯ä¿¡ç­¾åè€…æœºåˆ¶ä¿è¯å®‰å…¨æ€§
4. **æƒé™**: ä¾èµ– Token åˆçº¦çš„ minter æƒé™æ‰§è¡Œä»£å¸é“¸é€ 

è¿™ç§æ¶æ„åœ¨ä¿è¯å®‰å…¨æ€§çš„åŒæ—¶ï¼Œå®ç°äº†çµæ´»çš„ä»£å¸åˆ†å‘æ§åˆ¶æœºåˆ¶ã€‚